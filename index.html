<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>命运之轮 - 真实塔罗仪式</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; overflow: hidden; 
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 90%); 
            font-family: 'Cinzel', serif; 
            color: #d4af37; 
        }

        #camera-container {
            position: absolute; top: 20px; left: 20px;
            width: 160px; height: 120px; z-index: 10;
            border: 3px solid #d4af37; 
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            border-radius: 4px; overflow: hidden;
            transform: scaleX(-1); opacity: 0.8;
        }
        video { width: 100%; height: 100%; object-fit: cover; filter: sepia(0.5) contrast(1.2); }

        #header {
            position: absolute; top: 20px; width: 100%; text-align: center;
            pointer-events: none; z-index: 5;
        }
        h1 { margin: 0; font-size: 32px; letter-spacing: 5px; text-shadow: 0 0 20px #d4af37; }

        #ui-layer {
            position: absolute; bottom: 30px; width: 100%; text-align: center;
            pointer-events: none; z-index: 5;
        }
        #status { 
            font-size: 20px; letter-spacing: 2px;
            background: rgba(0,0,0,0.8); padding: 15px 40px;
            border: 1px solid #d4af37;
            display: inline-block; border-radius: 30px;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
            transition: all 0.3s;
        }

        .card-name {
            position: absolute; bottom: 180px; left: 50%; transform: translateX(-50%);
            font-size: 24px; color: #fff; text-shadow: 0 0 10px #d4af37;
            opacity: 0; transition: opacity 1s; pointer-events: none;
            text-align: center; width: 300px;
        }
        
        /* 进度条 (洗牌用) */
        #progress-bar {
            width: 0%; height: 4px; background: #d4af37; 
            margin-top: 10px; border-radius: 2px; transition: width 0.1s;
            display: none;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

    <div id="header"><h1>TAROT OF FATE</h1></div>
    <div id="camera-container"><video id="input_video"></video></div>

    <div id="card-name-0" class="card-name"></div>
    <div id="card-name-1" class="card-name"></div>
    <div id="card-name-2" class="card-name"></div>

    <div id="ui-layer">
        <div id="status">正在准备灵性连接...</div>
        <div style="width: 300px; margin: 0 auto;"><div id="progress-bar"></div></div>
    </div>

<script>
    // --- 1. 塔罗牌数据中心 (使用 GitHub Raw 资源) ---
    // 包含了 22 张大阿卡纳牌的文件名映射
    const TAROT_DATA = [
        { name: "0. The Fool (愚者)", file: "m00.jpg" },
        { name: "I. The Magician (魔术师)", file: "m01.jpg" },
        { name: "II. The High Priestess (女祭司)", file: "m02.jpg" },
        { name: "III. The Empress (皇后)", file: "m03.jpg" },
        { name: "IV. The Emperor (皇帝)", file: "m04.jpg" },
        { name: "V. The Hierophant (教皇)", file: "m05.jpg" },
        { name: "VI. The Lovers (恋人)", file: "m06.jpg" },
        { name: "VII. The Chariot (战车)", file: "m07.jpg" },
        { name: "VIII. Strength (力量)", file: "m08.jpg" },
        { name: "IX. The Hermit (隐士)", file: "m09.jpg" },
        { name: "X. Wheel of Fortune (命运之轮)", file: "m10.jpg" },
        { name: "XI. Justice (正义)", file: "m11.jpg" },
        { name: "XII. The Hanged Man (倒吊人)", file: "m12.jpg" },
        { name: "XIII. Death (死神)", file: "m13.jpg" },
        { name: "XIV. Temperance (节制)", file: "m14.jpg" },
        { name: "XV. The Devil (恶魔)", file: "m15.jpg" },
        { name: "XVI. The Tower (高塔)", file: "m16.jpg" },
        { name: "XVII. The Star (星星)", file: "m17.jpg" },
        { name: "XVIII. The Moon (月亮)", file: "m18.jpg" },
        { name: "XIX. The Sun (太阳)", file: "m19.jpg" },
        { name: "XX. Judgement (审判)", file: "m20.jpg" },
        { name: "XXI. The World (世界)", file: "m21.jpg" }
    ];

    // 图片加载器
    const textureLoader = new THREE.TextureLoader();
    const baseUrl = "https://raw.githubusercontent.com/rand7/tarot-images/master/cards/";
    
    // 预加载所有纹理，防止翻牌时黑屏
    TAROT_DATA.forEach(card => {
        textureLoader.load(baseUrl + card.file);
    });

    // --- 2. 基础 Three.js 场景 ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x1a0b2e, 0.03);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 5, 12);
    camera.lookAt(0, 0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
    scene.add(ambientLight);
    const spotLight = new THREE.SpotLight(0xffd700, 1.2);
    spotLight.position.set(0, 15, 5);
    spotLight.castShadow = true;
    scene.add(spotLight);

    // --- 3. 材质与模型 ---
    // 创建卡背纹理 (程序化生成)
    function createBackTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 256; canvas.height = 512;
        const ctx = canvas.getContext('2d');
        const grd = ctx.createRadialGradient(128, 256, 10, 128, 256, 256);
        grd.addColorStop(0, "#5e2a84"); grd.addColorStop(1, "#1a0b2e");
        ctx.fillStyle = grd; ctx.fillRect(0,0,256,512);
        
        ctx.strokeStyle = "#d4af37"; ctx.lineWidth = 15; ctx.strokeRect(10,10,236,492);
        ctx.beginPath(); ctx.arc(128, 256, 70, 0, Math.PI*2); ctx.stroke();
        
        ctx.fillStyle = "#d4af37"; ctx.font = "40px serif"; 
        ctx.textAlign = "center"; ctx.fillText("FATE", 128, 270);
        return new THREE.CanvasTexture(canvas);
    }
    const backTexture = createBackTexture();
    const sideMaterial = new THREE.MeshStandardMaterial({ color: 0x111111 });
    const backMaterial = new THREE.MeshStandardMaterial({ map: backTexture });

    const cards = [];
    const deckGroup = new THREE.Group();
    scene.add(deckGroup);

    // 初始化 22 张物理卡牌 (初始都是背面)
    for (let i = 0; i < 22; i++) {
        // 初始正面我们给一个“未知”的材质，翻牌时再替换为真实图片
        const tempFrontMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
        const materials = [sideMaterial, sideMaterial, sideMaterial, sideMaterial, tempFrontMat, backMaterial];
        const geometry = new THREE.BoxGeometry(1.5, 2.6, 0.02);
        const card = new THREE.Mesh(geometry, materials);
        
        // 初始堆叠位置
        card.position.set(0, 0, -i * 0.02);
        card.rotation.x = -Math.PI / 2;
        card.castShadow = true;
        
        card.userData = { id: i, isSelected: false, textureLoaded: false };
        cards.push(card);
        deckGroup.add(card);
    }
