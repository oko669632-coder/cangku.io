<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å‘½è¿ä¹‹è½® - çœŸå®å¡”ç½—ä»ªå¼</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; overflow: hidden; 
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 90%); 
            font-family: 'Cinzel', serif; 
            color: #d4af37; 
        }

        #camera-container {
            position: absolute; top: 20px; left: 20px;
            width: 160px; height: 120px; z-index: 10;
            border: 3px solid #d4af37; 
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            border-radius: 4px; overflow: hidden;
            transform: scaleX(-1); opacity: 0.8;
        }
        video { width: 100%; height: 100%; object-fit: cover; filter: sepia(0.5) contrast(1.2); }

        #header {
            position: absolute; top: 20px; width: 100%; text-align: center;
            pointer-events: none; z-index: 5;
        }
        h1 { margin: 0; font-size: 32px; letter-spacing: 5px; text-shadow: 0 0 20px #d4af37; }

        #ui-layer {
            position: absolute; bottom: 30px; width: 100%; text-align: center;
            pointer-events: none; z-index: 5;
        }
        #status { 
            font-size: 20px; letter-spacing: 2px;
            background: rgba(0,0,0,0.8); padding: 15px 40px;
            border: 1px solid #d4af37;
            display: inline-block; border-radius: 30px;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2);
            transition: all 0.3s;
        }

        .card-name {
            position: absolute; bottom: 180px; left: 50%; transform: translateX(-50%);
            font-size: 24px; color: #fff; text-shadow: 0 0 10px #d4af37;
            opacity: 0; transition: opacity 1s; pointer-events: none;
            text-align: center; width: 300px;
        }
        
        /* è¿›åº¦æ¡ (æ´—ç‰Œç”¨) */
        #progress-bar {
            width: 0%; height: 4px; background: #d4af37; 
            margin-top: 10px; border-radius: 2px; transition: width 0.1s;
            display: none;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

    <div id="header"><h1>TAROT OF FATE</h1></div>
    <div id="camera-container"><video id="input_video"></video></div>

    <div id="card-name-0" class="card-name"></div>
    <div id="card-name-1" class="card-name"></div>
    <div id="card-name-2" class="card-name"></div>

    <div id="ui-layer">
        <div id="status">æ­£åœ¨å‡†å¤‡çµæ€§è¿æ¥...</div>
        <div style="width: 300px; margin: 0 auto;"><div id="progress-bar"></div></div>
    </div>

<script>
    // --- 1. å¡”ç½—ç‰Œæ•°æ®ä¸­å¿ƒ (ä½¿ç”¨ GitHub Raw èµ„æº) ---
    // åŒ…å«äº† 22 å¼ å¤§é˜¿å¡çº³ç‰Œçš„æ–‡ä»¶åæ˜ å°„
    const TAROT_DATA = [
        { name: "0. The Fool (æ„šè€…)", file: "m00.jpg" },
        { name: "I. The Magician (é­”æœ¯å¸ˆ)", file: "m01.jpg" },
        { name: "II. The High Priestess (å¥³ç¥­å¸)", file: "m02.jpg" },
        { name: "III. The Empress (çš‡å)", file: "m03.jpg" },
        { name: "IV. The Emperor (çš‡å¸)", file: "m04.jpg" },
        { name: "V. The Hierophant (æ•™çš‡)", file: "m05.jpg" },
        { name: "VI. The Lovers (æ‹äºº)", file: "m06.jpg" },
        { name: "VII. The Chariot (æˆ˜è½¦)", file: "m07.jpg" },
        { name: "VIII. Strength (åŠ›é‡)", file: "m08.jpg" },
        { name: "IX. The Hermit (éšå£«)", file: "m09.jpg" },
        { name: "X. Wheel of Fortune (å‘½è¿ä¹‹è½®)", file: "m10.jpg" },
        { name: "XI. Justice (æ­£ä¹‰)", file: "m11.jpg" },
        { name: "XII. The Hanged Man (å€’åŠäºº)", file: "m12.jpg" },
        { name: "XIII. Death (æ­»ç¥)", file: "m13.jpg" },
        { name: "XIV. Temperance (èŠ‚åˆ¶)", file: "m14.jpg" },
        { name: "XV. The Devil (æ¶é­”)", file: "m15.jpg" },
        { name: "XVI. The Tower (é«˜å¡”)", file: "m16.jpg" },
        { name: "XVII. The Star (æ˜Ÿæ˜Ÿ)", file: "m17.jpg" },
        { name: "XVIII. The Moon (æœˆäº®)", file: "m18.jpg" },
        { name: "XIX. The Sun (å¤ªé˜³)", file: "m19.jpg" },
        { name: "XX. Judgement (å®¡åˆ¤)", file: "m20.jpg" },
        { name: "XXI. The World (ä¸–ç•Œ)", file: "m21.jpg" }
    ];

    // å›¾ç‰‡åŠ è½½å™¨
    const textureLoader = new THREE.TextureLoader();
    const baseUrl = "https://raw.githubusercontent.com/rand7/tarot-images/master/cards/";
    
    // é¢„åŠ è½½æ‰€æœ‰çº¹ç†ï¼Œé˜²æ­¢ç¿»ç‰Œæ—¶é»‘å±
    TAROT_DATA.forEach(card => {
        textureLoader.load(baseUrl + card.file);
    });

    // --- 2. åŸºç¡€ Three.js åœºæ™¯ ---
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x1a0b2e, 0.03);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 5, 12);
    camera.lookAt(0, 0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
    scene.add(ambientLight);
    const spotLight = new THREE.SpotLight(0xffd700, 1.2);
    spotLight.position.set(0, 15, 5);
    spotLight.castShadow = true;
    scene.add(spotLight);

    // --- 3. æè´¨ä¸æ¨¡å‹ ---
    // åˆ›å»ºå¡èƒŒçº¹ç† (ç¨‹åºåŒ–ç”Ÿæˆ)
    function createBackTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 256; canvas.height = 512;
        const ctx = canvas.getContext('2d');
        const grd = ctx.createRadialGradient(128, 256, 10, 128, 256, 256);
        grd.addColorStop(0, "#5e2a84"); grd.addColorStop(1, "#1a0b2e");
        ctx.fillStyle = grd; ctx.fillRect(0,0,256,512);
        
        ctx.strokeStyle = "#d4af37"; ctx.lineWidth = 15; ctx.strokeRect(10,10,236,492);
        ctx.beginPath(); ctx.arc(128, 256, 70, 0, Math.PI*2); ctx.stroke();
        
        ctx.fillStyle = "#d4af37"; ctx.font = "40px serif"; 
        ctx.textAlign = "center"; ctx.fillText("FATE", 128, 270);
        return new THREE.CanvasTexture(canvas);
    }
    const backTexture = createBackTexture();
    const sideMaterial = new THREE.MeshStandardMaterial({ color: 0x111111 });
    const backMaterial = new THREE.MeshStandardMaterial({ map: backTexture });

    const cards = [];
    const deckGroup = new THREE.Group();
    scene.add(deckGroup);

    // åˆå§‹åŒ– 22 å¼ ç‰©ç†å¡ç‰Œ (åˆå§‹éƒ½æ˜¯èƒŒé¢)
    for (let i = 0; i < 22; i++) {
        // åˆå§‹æ­£é¢æˆ‘ä»¬ç»™ä¸€ä¸ªâ€œæœªçŸ¥â€çš„æè´¨ï¼Œç¿»ç‰Œæ—¶å†æ›¿æ¢ä¸ºçœŸå®å›¾ç‰‡
        const tempFrontMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
        const materials = [sideMaterial, sideMaterial, sideMaterial, sideMaterial, tempFrontMat, backMaterial];
        const geometry = new THREE.BoxGeometry(1.5, 2.6, 0.02);
        const card = new THREE.Mesh(geometry, materials);
        
        // åˆå§‹å †å ä½ç½®
        card.position.set(0, 0, -i * 0.02);
        card.rotation.x = -Math.PI / 2;
        card.castShadow = true;
        
        card.userData = { id: i, isSelected: false, textureLoaded: false };
        cards.push(card);
        deckGroup.add(card);
    }

    // --- 4. é€»è¾‘æ§åˆ¶å˜é‡ ---
    let appState = 'IDLE'; 
    let drawnCount = 0;
    const selectedCardsData = []; 
    // å®šä¹‰è¿‡å»ã€ç°åœ¨ã€æœªæ¥çš„ä½ç½®
    const SLOTS = [
        { x: -4, y: 1.5, z: 2, label: "è¿‡å»" },
        { x: 0,  y: 1.5, z: 2, label: "ç°åœ¨" },
        { x: 4,  y: 1.5, z: 2, label: "æœªæ¥" }
    ];

    const uiStatus = document.getElementById('status');
    const progressBar = document.getElementById('progress-bar');

    // --- 5. æ ¸å¿ƒé€»è¾‘å‡½æ•° ---

    // A. æ´—ç‰ŒåŠ¨ç”» (å¸¦éœ‡åŠ¨å’Œè¿›åº¦æ¡)
    let shuffleTimer = null;
    function startShuffling() {
        if (appState !== 'IDLE') return;
        appState = 'SHUFFLING';
        uiStatus.innerHTML = "ğŸ”® èƒ½é‡æ³¨å…¥ä¸­... (è¯·ä¿æŒæ¡æ‹³)";
        progressBar.style.display = 'block';
        
        let progress = 0;
        
        // 3ç§’å€’è®¡æ—¶é€»è¾‘
        const duration = 3000; // 3000ms
        const interval = 50; 
        
        shuffleTimer = setInterval(() => {
            progress += (interval / duration) * 100;
            progressBar.style.width = progress + '%';
            
            // ç®€å•çš„æ´—ç‰Œè§†è§‰æ•ˆæœï¼šå¡ç‰Œéšæœºä¸Šä¸‹æŠ–åŠ¨
            cards.forEach(card => {
                card.position.y = (Math.random() - 0.5) * 0.5;
                card.rotation.z = (Math.random() - 0.5) * 0.1;
            });

            if (progress >= 100) {
                finishShuffling();
            }
        }, interval);
    }

    function finishShuffling() {
        clearInterval(shuffleTimer);
        // å¤ä½å¡ç‰Œ
        cards.forEach((card, i) => {
            new TWEEN.Tween(card.position).to({ y: 0, x: 0 }, 300).start();
            new TWEEN.Tween(card.rotation).to({ z: 0 }, 300).start();
        });

        appState = 'READY_TO_SPREAD';
        uiStatus.innerHTML = "âœ¨ æ´—ç‰Œå®Œæˆï¼è¯· <b>å¼ å¼€æ‰‹æŒ</b> é“ºå¼€ç‰Œé˜µ";
        progressBar.style.display = 'none';
    }

    // B. é“ºå¼€ç‰Œ (Fanning)
    function spreadCards() {
        if (appState !== 'READY_TO_SPREAD') return;
        appState = 'FANNING';
        uiStatus.innerHTML = "ğŸ´ è¯·ä¼¸å‡º <b>é£ŸæŒ‡</b> æ„Ÿåº”å¹¶æŠ½å–ä¸€å¼ ç‰Œ";

        const totalArc = Math.PI * 0.8;
        const radius = 5;
        cards.forEach((card, index) => {
            const angle = (index / 22) * totalArc - (totalArc / 2);
            new TWEEN.Tween(card.position)
                .to({ x: Math.sin(angle)*radius, y: -1, z: Math.cos(angle)*radius - 6 }, 1000)
                .easing(TWEEN.Easing.Back.Out)
                .start();
            new TWEEN.Tween(card.rotation)
                .to({ x: -0.5, y: -angle, z: 0 }, 1000)
                .start();
        });
        setTimeout(() => { appState = 'WAITING_FOR_PICK'; }, 1000);
    }

    // C. æŠ½ç‰Œ (Picking)
    function pickCard() {
        if (appState !== 'WAITING_FOR_PICK' || drawnCount >= 3) return;
        appState = 'PICKING'; // é”å®šçŠ¶æ€é˜²æ­¢è¿ç‚¹

        const available = cards.filter(c => !c.userData.isSelected);
        if(available.length === 0) return;

        // éšæœºé€‰æ‹©ä¸€å¼ ç‰©ç†å¡ç‰Œ
        const card = available[Math.floor(Math.random() * available.length)];
        card.userData.isSelected = true;

        // --- å…³é”®ï¼šåœ¨è¿™é‡Œåˆ†é…çœŸå®çš„å¡”ç½—ç‰Œæ•°æ® ---
        // ä¸ºäº†ä¸é‡å¤ï¼Œæˆ‘ä»¬ä»æ•°æ®æºé‡ŒéšæœºæŒ‘ä¸€ä¸ªï¼Œç„¶åä»æºæ•°æ®é‡Œåˆ é™¤å®ƒ(æˆ–æ ‡è®°)
        // ç®€å•èµ·è§ï¼Œè¿™é‡Œåšä¸€ä¸ªéšæœºç´¢å¼•
        const randDataIndex = Math.floor(Math.random() * TAROT_DATA.length);
        const cardInfo = TAROT_DATA[randDataIndex];
        // ä»æ•°ç»„ä¸­ç§»é™¤å·²é€‰çš„ï¼Œé˜²æ­¢é‡å¤æŠ½åˆ°åŒä¸€å¼ ç‰Œ
        TAROT_DATA.splice(randDataIndex, 1);

        // è®°å½•æ•°æ®
        const slot = SLOTS[drawnCount];
        selectedCardsData.push({ mesh: card, info: cardInfo, slotIndex: drawnCount });

        // åŠ è½½çœŸå®çº¹ç†å¹¶åº”ç”¨åˆ°å¡ç‰Œæ­£é¢ (æè´¨ç´¢å¼•4)
        textureLoader.load(baseUrl + cardInfo.file, (tex) => {
            card.material[4] = new THREE.MeshStandardMaterial({ map: tex });
            card.material.needsUpdate = true;
        });

        // åŠ¨ç”»ï¼šé£å‘å¯¹åº”ä½ç½®
        playAudio(400 + drawnCount * 100); // ç®€å•çš„éŸ³æ•ˆ

        new TWEEN.Tween(card.position).to({ x: slot.x, y: slot.y, z: slot.z }, 1000).easing(TWEEN.Easing.Cubic.Out).start();
        new TWEEN.Tween(card.rotation).to({ x: 0, y: 0, z: 0 }, 1000).start(); // ä¾ç„¶èƒŒé¢æœä¸Š
        new TWEEN.Tween(card.scale).to({ x: 1.1, y: 1.1, z: 1.1 }, 1000).onComplete(() => {
            drawnCount++;
            if(drawnCount < 3) {
                appState = 'WAITING_FOR_PICK';
                const nextType = drawnCount === 1 ? "ç°åœ¨" : "æœªæ¥";
                uiStatus.innerHTML = `å·²é€‰å®š[${SLOTS[drawnCount-1].label}]ï¼Œè¯·ç»§ç»­æŠ½å– <b>${nextType}</b>`;
            } else {
                appState = 'REVEALING';
                uiStatus.innerHTML = "ğŸ”® å‘½è¿å³å°†æ­æ™“...";
                setTimeout(revealCards, 1500);
            }
        }).start();
    }

    // D. ç¿»ç‰Œ (Revealing)
    function revealCards() {
        selectedCardsData.forEach((item, i) => {
            setTimeout(() => {
                // ç¿»è½¬åŠ¨ç”»
                new TWEEN.Tween(item.mesh.rotation)
                    .to({ y: Math.PI }, 1500)
                    .easing(TWEEN.Easing.Elastic.Out)
                    .start();
                
                // æ˜¾ç¤ºåç§°æ–‡å­—
                const label = document.getElementById(`card-name-${i}`);
                label.innerText = `${SLOTS[i].label}: ${item.info.name}`;
                // è®¡ç®—2Dä½ç½®
                const vector = item.mesh.position.clone();
                vector.project(camera);
                const x = (vector.x * .5 + .5) * window.innerWidth;
                const y = (-(vector.y * .5) + .5) * window.innerHeight;
                label.style.left = x + 'px';
                label.style.top = (y + 120) + 'px'; // æ–‡å­—åœ¨ç‰Œä¸‹æ–¹
                label.style.opacity = 1;
                
                playAudio(800 + i * 200);

            }, i * 1000);
        });
        setTimeout(() => {
            uiStatus.innerHTML = "âœ¨ ä»ªå¼å®Œæˆã€‚";
            appState = 'FINISHED';
        }, 3500);
    }

    // ç®€æ˜“éŸ³æ•ˆ
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playAudio(freq) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
        osc.start(); osc.stop(audioCtx.currentTime + 0.5);
    }

    // --- 6. æ‰‹åŠ¿è¯†åˆ«é€»è¾‘æ›´æ–° ---
    const videoEl = document.getElementById('input_video');
    function onResults(results) {
        if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
            // å¦‚æœæ‰‹ç§»å¼€äº†ï¼Œä¸”æ­£åœ¨æ´—ç‰Œï¼Œæ˜¯å¦éœ€è¦æš‚åœï¼Ÿ
            // ç®€å•èµ·è§ï¼šå¦‚æœæ‰‹ç§»å¼€ï¼Œå¦‚æœæ­£åœ¨æ´—ç‰Œï¼Œæˆ‘ä»¬ä¿æŒæ´—ç‰Œç›´åˆ°æ—¶é—´ç»“æŸæˆ–è€…é‡ç½®ã€‚
            // è¿™é‡Œä¸ºäº†ä½“éªŒæµç•…ï¼Œæˆ‘ä»¬ä¸åšä¸­æ–­å¤„ç†ã€‚
            return;
        }
        const lm = results.multiHandLandmarks[0];

        // ç®€å•çš„æ‰‹æŒ‡åˆ¤æ–­
        const isIndexOpen = lm[8].y < lm[6].y;
        const isPinkyOpen = lm[20].y < lm[18].y;
        
        // æ‹³å¤´ï¼šæ‰€æœ‰æ‰‹æŒ‡å¼¯æ›²ï¼ˆè¿™é‡Œç®€åŒ–åˆ¤æ–­ï¼šé£ŸæŒ‡å’Œå°æŒ‡éƒ½å¼¯æ›²ï¼‰
        const isFist = !isIndexOpen && !isPinkyOpen; 
        // å¼ å¼€ï¼šé£ŸæŒ‡å’Œå°æŒ‡éƒ½ä¼¸ç›´
        const isPalm = isIndexOpen && isPinkyOpen; 
        // é£ŸæŒ‡ï¼šé£ŸæŒ‡ä¼¸ç›´ï¼Œå°æŒ‡å¼¯æ›²
        const isPoint = isIndexOpen && !isPinkyOpen;

        // çŠ¶æ€æœºæµè½¬
        if (appState === 'IDLE') {
            if (isFist) {
                startShuffling(); // æ¡æ‹³ -> å¼€å§‹æ´—ç‰Œ
            } else {
                uiStatus.innerHTML = "è¯·å¯¹ç€é•œå¤´ <b>æ¡ç´§æ‹³å¤´</b> ä»¥å¼€å§‹æ´—ç‰Œ";
            }
        }
        else if (appState === 'SHUFFLING') {
            // å¯ä»¥åœ¨è¿™é‡ŒåŠ é€»è¾‘ï¼šå¦‚æœç”¨æˆ·æ¾å¼€æ‹³å¤´ï¼Œæ´—ç‰Œæš‚åœï¼Ÿ
            // ç›®å‰é€»è¾‘æ˜¯è‡ªåŠ¨è¿›è¡Œ3ç§’ï¼Œä¸éœ€è¦ä¸€ç›´æ¡ç€ï¼Œä½†æ¡ç€æ›´æœ‰æ„Ÿè§‰ã€‚
        }
        else if (appState === 'READY_TO_SPREAD') {
            if (isPalm) {
                spreadCards(); // å¼ å¼€ -> é“ºå¼€
            }
        }
        else if (appState === 'WAITING_FOR_PICK') {
            if (isPoint) {
                pickCard(); // é£ŸæŒ‡ -> æŠ½ç‰Œ
            }
        }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
    hands.onResults(onResults);
    
    const cameraUtils = new Camera(videoEl, {
        onFrame: async () => { await hands.send({image: videoEl}); },
        width: 320, height: 240
    });
    cameraUtils.start();

    // --- 7. æ¸²æŸ“å¾ªç¯ ---
    function animate() {
        requestAnimationFrame(animate);
        TWEEN.update();
        renderer.render(scene, camera);
    }
    animate();

    // çª—å£è‡ªé€‚åº”
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

</script>
</body>
</html>
