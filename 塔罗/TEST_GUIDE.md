# AI 解牌功能测试指南

## 功能清单

### ✅ 已实现的功能

- [x] **配置面板** - 右上角 ⚙️ 可配置 AI 参数
- [x] **AI 启用开关** - 可启用/禁用 AI 解牌功能
- [x] **API 配置** - 支持自定义 API URL、密钥、模型
- [x] **解牌语言选择** - 中文/英文/中英双语
- [x] **解牌风格选择** - 4 种风格（神秘学派/心理学派/实用主义/诗意派）
- [x] **配置保存** - 使用 localStorage 保存用户配置
- [x] **API 测试连接** - 验证 API 配置是否正确
- [x] **解牌面板** - 完整的解牌显示界面
- [x] **AI 调用** - 集成 OpenAI 兼容的 API
- [x] **默认解读** - AI 不可用时显示备用解读
- [x] **错误处理** - 优雅处理 API 错误和超时
- [x] **流程集成** - 抽牌后自动进入解牌环节

---

## 测试场景

### 场景 1: 不配置 AI（默认模式）

**步骤：**
1. 启动应用，点击"进入仪式"
2. 完成握拳→张掌→抽三张牌的流程
3. 牌翻转后，应进入解牌面板

**期望结果：**
- 显示"✨ 灵能解读（AI 未启用）"
- 1 秒后显示默认的静态解读文本
- 可以点击"下一张"和"完成仪式"按钮

**测试检查点：**
- [ ] 是否成功进入解牌面板
- [ ] 是否显示正确的牌名
- [ ] 是否显示默认解读（不是 AI 调用）
- [ ] 按钮功能是否正常

---

### 场景 2: 配置 AI（OpenAI）

**准备：**
- 有 OpenAI API 账户和密钥

**步骤：**
1. 启动应用，点击"进入仪式"
2. 右上角 ⚙️ 面板中：
   - 打开"启用 AI 解牌"开关
   - API 基础 URL: `https://api.openai.com/v1`
   - API 密钥: 输入你的密钥
   - 模型: `gpt-3.5-turbo` 或 `gpt-4`
   - 解牌语言: `中文`
   - 解牌风格: `神秘学派`
3. 点击"测试连接"

**期望结果：**
- 显示 "✓ 连接成功"
- 配置被保存到本地存储

**测试检查点：**
- [ ] 开关是否能切换状态
- [ ] 输入框是否能保存内容
- [ ] 测试连接是否能正确判断连接状态
- [ ] 刷新页面后配置是否保留

---

### 场景 3: 配置 AI（DeepSeek）

**准备：**
- 有 DeepSeek API 账户和密钥

**步骤：**
1. 启动应用，点击"进入仪式"
2. 右上角 ⚙️ 面板中：
   - 打开"启用 AI 解牌"开关
   - API 基础 URL: `https://api.deepseek.com/v1`
   - API 密钥: 输入你的密钥
   - 模型: `deepseek-chat`
   - 其他配置随意选择
3. 点击"保存设置"
4. 完成握拳→张掌→抽三张牌流程
5. 进入解牌面板

**期望结果：**
- 显示 "✨ 灵能感应中..."
- 1-3 秒后显示 AI 生成的解读
- 解读内容为中文，符合"神秘学派"风格

**测试检查点：**
- [ ] 是否成功调用 AI API
- [ ] 解读是否为中文
- [ ] 解读是否与牌义相关
- [ ] 解读长度是否合理（200-300 字）
- [ ] 是否显示系统提示或错误信息

---

### 场景 4: 解牌面板交互

**准备：**
- 已配置 AI 并成功进入解牌面板

**步骤：**
1. 观察第一张牌的解读
2. 点击"下一张"按钮
3. 查看第二张牌的解读
4. 点击"下一张"按钮
5. 查看第三张牌的解读
6. 点击"完成仪式"按钮

**期望结果：**
- 每点击"下一张"，牌名和解读都会更新
- 第三张牌后点击"下一张"应显示"完成仪式"或自动返回主界面
- 点击"完成仪式"后应返回初始状态

**测试检查点：**
- [ ] 牌名是否正确更新（过去→现在→未来）
- [ ] 解读是否正确加载
- [ ] 按钮是否响应迅速
- [ ] 返回主界面后是否能开始新仪式

---

### 场景 5: 不同语言和风格组合

**准备：**
- 已配置 AI

**测试用例：**

| 语言 | 风格 | 预期特征 |
|-----|-----|--------|
| 中文 | 神秘学派 | 象征、能量、数字学术语 |
| 中文 | 心理学派 | 心理学词汇、潜意识、自我认知 |
| 中文 | 实用主义 | 建议、行动、决策支持 |
| 中文 | 诗意派 | 文学性、优美措辞、冥想式 |
| 英文 | 任意 | 英文解读 |
| 中英双语 | 任意 | 同时显示中英文 |

**测试方法：**
1. 修改配置面板中的语言和风格
2. 点击"保存设置"
3. 进行一次完整的抽牌→解牌流程
4. 观察解读内容是否符合预期特征

**测试检查点：**
- [ ] 每种语言组合是否都能生成内容
- [ ] 不同风格的解读是否有明显差异
- [ ] 解读质量是否可接受

---

### 场景 6: 错误处理

**测试 6.1：错误的 API 密钥**
- 配置：正确的 URL，错误的密钥
- 点击"测试连接"
- **期望：** "✗ 连接失败，请检查配置"

**测试 6.2：网络错误**
- 配置正确但断网
- 完成抽牌流程进入解牌
- **期望：** "✗ 灵能感应中断" + 显示默认解读

**测试 6.3：超时处理**
- 配置正确但 API 响应很慢
- **期望：** 显示默认解读（不冻结）

**测试检查点：**
- [ ] 是否能正确检测错误
- [ ] 是否有用户友好的错误消息
- [ ] 是否优雅降级到默认解读
- [ ] 应用是否保持响应状态（未冻结）

---

### 场景 7: 性能和稳定性

**测试 7.1：连续仪式**
- 完成一次完整仪式
- 不刷新页面，直接进行第二次仪式
- **期望：** 流程正常，无报错

**测试 7.2：快速开关 AI**
- 多次切换 AI 启用开关
- **期望：** 状态正确切换，无冻结

**测试 7.3：大量配置修改**
- 多次修改和保存配置
- **期望：** 配置正确保存，无数据丢失

**测试检查点：**
- [ ] 是否存在内存泄漏
- [ ] 是否存在网络请求未取消
- [ ] 是否存在 localStorage 溢出
- [ ] 浏览器控制台是否有报错

---

## 浏览器开发者工具检查清单

### 网络标签 (Network)
- [ ] `/chat/completions` 请求是否成功（200 状态码）
- [ ] 请求头是否包含正确的 Authorization
- [ ] 响应是否包含 `choices[0].message.content`

### 控制台标签 (Console)
- [ ] 是否有 CORS 错误
- [ ] 是否有 JavaScript 语法错误
- [ ] API 调用是否有日志输出

### 存储标签 (Application)
- [ ] localStorage 中是否保存了：
  - `ai_enabled`
  - `ai_api_url`
  - `ai_api_key`
  - `ai_model`
  - `reading_language`
  - `reading_style`

---

## 快速测试脚本

### 在浏览器控制台运行（用于快速测试）

```javascript
// 查看当前配置
console.log('AI Config:', {
  enabled: localStorage.getItem('ai_enabled'),
  url: localStorage.getItem('ai_api_url'),
  model: localStorage.getItem('ai_model'),
  language: localStorage.getItem('reading_language'),
  style: localStorage.getItem('reading_style')
});

// 清除所有配置
Object.keys(localStorage)
  .filter(k => k.startsWith('ai_') || k.startsWith('reading_'))
  .forEach(k => localStorage.removeItem(k));

// 测试 API 连接
fetch('https://api.openai.com/v1/chat/completions', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_KEY_HERE'
  },
  body: JSON.stringify({
    model: 'gpt-3.5-turbo',
    messages: [{role: 'user', content: 'ping'}],
    max_tokens: 10
  })
}).then(r => r.json()).then(d => console.log('Success:', d));
```

---

## 报告问题的模板

如遇到问题，请报告以下信息：

```markdown
## 问题描述
[描述问题]

## 重现步骤
1. [步骤1]
2. [步骤2]
3. [步骤3]

## 期望行为
[应该发生什么]

## 实际行为
[实际发生了什么]

## 环境信息
- 浏览器: [Chrome/Firefox/Safari/Edge]
- 版本: [版本号]
- AI服务: [OpenAI/DeepSeek/其他]
- 模型: [gpt-4/deepseek-chat/其他]

## 错误信息
[控制台错误截图或日志]

## 配置信息
- API URL: [已脱敏]
- 模型: [模型名]
- 语言: [语言]
- 风格: [风格]
```

---

## ✅ 验收标准

### 必需功能
- [ ] 应用可以在没有 AI 的情况下正常运行
- [ ] 配置面板可以正确保存和加载设置
- [ ] API 测试连接功能正常
- [ ] 抽牌后可以进入解牌面板
- [ ] 解牌面板显示正确的牌名
- [ ] 可以浏览三张牌的解读
- [ ] 完成仪式后可以重新开始

### 可选功能
- [ ] AI 集成正常工作
- [ ] 多种语言和风格可以使用
- [ ] 错误处理优雅（不冻结不崩溃）
- [ ] 支持多个 AI 服务商

---

祝测试顺利！✨🔮✨
